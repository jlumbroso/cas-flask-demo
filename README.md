# CAS Flask Demo (Render-ready)

Tiny Flask app that authenticates via your **Quick-CAS proxy** and shows the
logged-in user plus CAS attributes. Designed to deploy on **Render** with a single Blueprint.

## Deploy on Render

1. Fork / upload this folder to a repo.
2. In Render, **New +** → **Blueprint** → point to your repo.
3. When prompted, set these env vars:

- `CAS_BASE` (required): base URL of your proxy, e.g.
  `https://alliance.seas.upenn.edu/~lumbroso/cgi-bin/cas`
- `SERVICE_BASE_URL` (recommended): your Render URL,
  e.g. `https://cas-flask-demo.onrender.com`
- `SECRET_KEY`: auto-generated by render.yaml
- `DEBUG_XML`: `true` to log raw CAS XML to stdout (optional)

The service listens on `$PORT` and exposes `/healthz` for Render’s health checks.

## Local run

```bash
python -m venv .venv && source .venv/bin/activate
pip install -r requirements.txt

export FLASK_DEBUG=1
export SECRET_KEY=dev
export CAS_BASE="https://alliance.seas.upenn.edu/~lumbroso/cgi-bin/cas"
# If you run locally without a public URL, use ngrok and set SERVICE_BASE_URL
# export SERVICE_BASE_URL="https://<your-ngrok>.ngrok-free.app"

python app.py
# browse http://127.0.0.1:5000
```

## How it works

- `/login` redirects to `CAS_BASE/login.php?service=<SERVICE_BASE_URL>/callback`
- `/callback` calls `CAS_BASE/serviceValidate.php` with `ticket` and `service`
- XML parser accepts both:
  - Canonical CAS-2.0: `<cas:authenticationSuccess><cas:attributes>…</cas:attributes></cas:authenticationSuccess>`
  - Legacy: `<cas:attribute name="…" >value</cas:attribute>` as siblings
- On success, it stores `cas_user` and `cas_attrs` in the session and shows **/profile**.

If validation redirects (302) back to the IdP, your proxy’s `serviceValidate.php`
is probably still Shibboleth-gated. Ensure your `.htaccess` contains:

```apache
<Files "serviceValidate.php">
  ShibRequestSetting requireSession 0
  Require all granted
</Files>
```

## Files

- `app.py` — the Flask app (binds to `$PORT`, has `/healthz`)
- `requirements.txt` — Flask, requests, gunicorn
- `render.yaml` — Render Blueprint with health check
- `README.md` — you’re reading it

Have fun!
